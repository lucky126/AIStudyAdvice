@inject IJSRuntime JS
@using System.Text.RegularExpressions

<div @ref="container" class="@Class" style="@Style"></div>

@code {
    [Parameter] public string Content { get; set; } = "";
    [Parameter] public string Class { get; set; } = "";
    [Parameter] public string Style { get; set; } = "";

    private ElementReference container;
    private bool shouldRender = true;

    protected override bool ShouldRender() => shouldRender;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Whenever the component renders (after parameters change), update content and typeset
        if (!string.IsNullOrEmpty(Content))
        {
            try 
            {
                // Try to fix missing delimiters for mixed text/math content
                var processedContent = Study.Shared.MathHelper.FixMathContent(Content);
                
                // Encode content to prevent HTML tag interpretation (e.g. <m)
                // We assume Content is raw text with LaTeX, not HTML
                var encoded = System.Net.WebUtility.HtmlEncode(processedContent);
                await JS.InvokeVoidAsync("setMathContent", container, encoded);
            }
            catch (Exception ex)
            {
                // Ignore JS disconnected errors during navigation
                Console.WriteLine($"MathJax render error: {ex.Message}");
            }
        }
    }

    // Private helper moved to Shared/MathHelper.cs
}
