@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@using Study.Services

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 1. 先检查 C# 状态
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                return;
            }

            // 2. 双重检查：直接询问浏览器 LocalStorage 是否有 Token
            try 
            {
                var userSession = await JS.InvokeAsync<string>("localStorage.getItem", "UserSession");
                var adminSession = await JS.InvokeAsync<string>("localStorage.getItem", "AdminSession");

                if (!string.IsNullOrEmpty(userSession) || !string.IsNullOrEmpty(adminSession))
                {
                    // 关键修复：如果 JS 发现有 Token 但 C# 没读到，强制触发一次状态加载
                    if (AuthStateProvider is CustomAuthenticationStateProvider customProvider)
                    {
                        await customProvider.LoadStateAsync();
                    }
                    return; 
                }
            }
            catch
            {
                // 忽略 JS 错误
            }

            // 3. 确认未登录，执行跳转
            var uri = Nav.Uri;
            if (uri.ToLower().Contains("/admin"))
            {
                Nav.NavigateTo("/admin/login", true);
            }
            else
            {
                Nav.NavigateTo("/login", true);
            }
        }
    }
}