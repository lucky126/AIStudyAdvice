@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@using Study.Services

<div class="d-flex flex-column align-items-center justify-content-center vh-100 bg-light">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h5 class="text-secondary mb-2">正在验证身份...</h5>
    <p class="text-muted small">如果长时间未跳转，请 <a href="/login" class="text-primary text-decoration-none">点击这里登录</a></p>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 1. 先检查 C# 状态
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var isAuthenticated = authState.User.Identity?.IsAuthenticated == true;
            
            if (isAuthenticated)
            {
                // Do not return, allow redirection to login page with different role or permissions
            }

            // 2. 双重检查：直接询问浏览器 LocalStorage 是否有 Token
            try 
            {
                // Only check LocalStorage if NOT authenticated (or if we suspect partial auth)
                if (!isAuthenticated)
                {
                    var userSession = await JS.InvokeAsync<string>("localStorage.getItem", "UserSession");
                    var adminSession = await JS.InvokeAsync<string>("localStorage.getItem", "AdminSession");
                        
                    if (!string.IsNullOrEmpty(userSession) || !string.IsNullOrEmpty(adminSession))
                    {
                        // 如果 JS 发现有 Token 但 C# 没读到，强制触发一次状态加载
                        if (AuthStateProvider is CustomAuthenticationStateProvider customProvider)
                        {
                            await customProvider.LoadStateAsync();
                            
                            // 给一点时间让状态更新生效
                            await Task.Delay(500);
                            
                            // 再次检查状态
                            authState = await AuthStateProvider.GetAuthenticationStateAsync();
                            isAuthenticated = authState.User.Identity?.IsAuthenticated == true;
                            
                            if (isAuthenticated)
                            {
                                // 认证成功，页面会自动刷新到 Authorized 视图，无需手动跳转
                                return;
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                // Ignore errors
            }

            // 3. Determine Redirection Logic based on "Two Systems" requirement
            var uri = Nav.Uri;
            var uriPath = new Uri(uri).AbsolutePath.ToLowerInvariant();
            var isTargetingAdmin = uriPath.StartsWith("/admin");
            
            // Check current roles
            var isAdmin = authState.User.IsInRole("Admin");
            var isUser = authState.User.IsInRole("User");
            
            string targetUrl = null;

            if (isTargetingAdmin)
            {
                // We are targeting Admin area
                // If we are NOT an admin, go to Admin Login
                if (!isAdmin)
                {
                    targetUrl = "/admin/login";
                }
            }
            else
            {
                // We are targeting User area
                // If we are NOT a user, go to User Login
                if (!isUser)
                {
                    targetUrl = "/login";
                }
            }

            if (targetUrl != null)
            {
                // Avoid infinite loops if we are already there
                if (uriPath.EndsWith(targetUrl.ToLowerInvariant()))
                {
                     return;
                }

                // Short delay to ensure UI renders
                await Task.Delay(500);
                Nav.NavigateTo(targetUrl, true);
            }
        }
    }
}
