@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IJSRuntime JS

<div class="card shadow-sm border-0 rounded-3">
    <div class="card-header bg-white border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title text-primary fw-bold mb-0">
            <span class="oi oi-cloud-upload me-2"></span>上传作业图片
        </h5>
        @if (OnClose.HasDelegate)
        {
            <button type="button" class="btn-close" aria-label="Close" @onclick="OnClose"></button>
        }
    </div>
    <div class="card-body">
        <div class="d-flex gap-3 mb-3">
            <label class="btn btn-outline-secondary flex-grow-1 d-flex flex-column justify-content-center align-items-center py-3" style="border-style: dashed; min-height: 100px;">
                <span class="oi oi-image mb-2" style="font-size: 1.5rem"></span>
                <span>相册选择</span>
                <InputFile OnChange="OnInputFileChange" accept="image/png,image/jpeg" style="display: none" />
            </label>
            <label class="btn btn-primary flex-grow-1 d-flex flex-column justify-content-center align-items-center py-3" style="min-height: 100px;">
                <span class="oi oi-camera-slr mb-2" style="font-size: 1.5rem"></span>
                <span>直接拍照</span>
                <InputFile OnChange="OnInputFileChange" accept="image/*" capture="environment" style="display: none" />
            </label>
        </div>

        @if (selectedFile != null)
        {
            <div class="mb-3">
                <p>已选择: <strong>@selectedFile.Name</strong></p>
                <button class="btn btn-primary" @onclick="Upload" disabled="@isUploading">
                    @if (isUploading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span> 上传中...</span>
                    }
                    else
                    {
                        <span>确认上传</span>
                    }
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(error))
        {
            <p class="text-danger mt-2">@error</p>
        }
        @if (resultOk)
        {
            <p class="text-success mt-2">上传并解析成功</p>
        }
    </div>
</div>

@code {
    [Parameter] public int Grade { get; set; }
    [Parameter] public string Subject { get; set; } = "数学";
    [Parameter] public string? Publisher { get; set; }
    [Parameter] public EventCallback OnUploaded { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string error = "";
    private bool resultOk = false;
    private IBrowserFile? selectedFile;
    private bool isUploading = false;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        error = "";
        resultOk = false;
        selectedFile = e.File;
    }

    private async Task Upload()
    {
        if (selectedFile == null)
        {
            error = "请选择图片文件";
            return;
        }

        if (!(selectedFile.ContentType == "image/png" || selectedFile.ContentType == "image/jpeg"))
        {
            error = "仅支持 JPG/PNG";
            return;
        }

        isUploading = true;
        try
        {
            using var stream = selectedFile.OpenReadStream(10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());

            var req = new { base64Image = base64, grade = Grade, subject = Subject, publisher = Publisher };
            var resp = await Http.PostAsJsonAsync("/api/upload", req);
            if (!resp.IsSuccessStatusCode)
            {
                var problem = await resp.Content.ReadFromJsonAsync<ProblemDetails>();
                error = $"解析失败: {problem?.Detail ?? resp.ReasonPhrase}";
                return;
            }

            resultOk = true;
            selectedFile = null; // Clear selection after success
            await OnUploaded.InvokeAsync();
        }
        catch (Exception ex)
        {
            error = $"上传出错: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private class ProblemDetails { public string? Detail { get; set; } }
}
