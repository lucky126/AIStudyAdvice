@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IJSRuntime JS

<div class="card">
    <div class="card-header">上传作业图片 - 支持 JPG/PNG</div>
    <div class="card-body">
        <InputFile OnChange="OnInputFileChange" accept="image/png,image/jpeg" class="form-control mb-3" />

        @if (selectedFile != null)
        {
            <div class="mb-3">
                <p>已选择: <strong>@selectedFile.Name</strong></p>
                <button class="btn btn-primary" @onclick="Upload" disabled="@isUploading">
                    @if (isUploading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span> 上传中...</span>
                    }
                    else
                    {
                        <span>确认上传</span>
                    }
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(error))
        {
            <p class="text-danger mt-2">@error</p>
        }
        @if (resultOk)
        {
            <p class="text-success mt-2">上传并解析成功</p>
        }
    </div>
</div>

@code {
    [Parameter] public int Grade { get; set; }
    [Parameter] public string Subject { get; set; } = "数学";
    [Parameter] public string? Publisher { get; set; }
    [Parameter] public EventCallback OnUploaded { get; set; }

    private string error = "";
    private bool resultOk = false;
    private IBrowserFile? selectedFile;
    private bool isUploading = false;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        error = "";
        resultOk = false;
        selectedFile = e.File;
    }

    private async Task Upload()
    {
        if (selectedFile == null)
        {
            error = "请选择图片文件";
            return;
        }

        if (!(selectedFile.ContentType == "image/png" || selectedFile.ContentType == "image/jpeg"))
        {
            error = "仅支持 JPG/PNG";
            return;
        }

        isUploading = true;
        try
        {
            using var stream = selectedFile.OpenReadStream(10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());

            var req = new { base64Image = base64, grade = Grade, subject = Subject, publisher = Publisher };
            var resp = await Http.PostAsJsonAsync("/api/upload", req);
            if (!resp.IsSuccessStatusCode)
            {
                var problem = await resp.Content.ReadFromJsonAsync<ProblemDetails>();
                error = $"解析失败: {problem?.Detail ?? resp.ReasonPhrase}";
                return;
            }

            resultOk = true;
            selectedFile = null; // Clear selection after success
            await OnUploaded.InvokeAsync();
        }
        catch (Exception ex)
        {
            error = $"上传出错: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private class ProblemDetails { public string? Detail { get; set; } }
}
