@page "/dashboard"
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>学习中心</PageTitle>

<div class="container mt-3">
    @if (!initialized)
    {
        <p>正在加载...</p>
    }
    else if (string.IsNullOrEmpty(subject) || grade == 0)
    {
        <div class="alert alert-warning">请先在首页选择年级与学科</div>
    }
    else
    {
        @if (hasData)
        {
            <div class="card mb-3">
                <div class="card-header">学情分析</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>知识点</th>
                                <th>正确率</th>
                                <th>掌握等级</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var r in report)
                        {
                            var cls = r.mastery == "熟练掌握" ? "text-success"
                                : r.mastery == "掌握" ? "text-primary"
                                : r.mastery == "了解" ? "text-warning"
                                : "text-danger";
                            <tr>
                                <td><a href="/kp?kp=@Uri.EscapeDataString(r.knowledgePoint)">@r.knowledgePoint</a></td>
                                <td>@string.Format("{0:P2}", r.accuracy)</td>
                                <td class="@cls">@r.mastery</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary me-2" @onclick="@(() => showUpload = true)">上传新作业</button>
                        <button class="btn btn-primary" @onclick="@GoPractice">专项练习</button>
                        <button class="btn btn-success ms-2" @onclick="LoadAdvice">学习顾问反馈</button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">欢迎！请上传第一份作业</div>
        }

        @if (showUpload || !hasData)
        {
            <UploadSection Grade="@grade" Subject="@subject" Publisher="@textbookVersion" OnUploaded="OnUploaded" />
        }

        @if (advice != null)
        {
            <div class="card mt-3">
                <div class="card-header">学习顾问</div>
                <div class="card-body">
                    <p>@advice.summary</p>
                    <ul>
                        @foreach (var tip in advice.suggestions)
                        {
                            <li>@tip</li>
                        }
                    </ul>
                </div>
            </div>
        }
    }
</div>

@code {
    private int grade;
    private string subject = "";
    private string textbookVersion = "";
    private bool initialized = false;
    private bool hasData = false;
    private bool showUpload = false;

    private List<ReportItem> report = new();
    private AdviceResult? advice;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var cfg = await JS.InvokeAsync<Config>("loadConfig");
                grade = cfg.grade;
                subject = cfg.subject ?? "";
                textbookVersion = cfg.textbookVersion ?? "";
                initialized = true;
                StateHasChanged();

                if (!string.IsNullOrEmpty(subject) && grade > 0)
                {
                    var res = await Http.GetFromJsonAsync<AnalyticsResponse>($"/api/analytics?grade={grade}&subject={subject}");
                    report = res?.report ?? new List<ReportItem>();
                    hasData = report.Count > 0;
                    StateHasChanged();
                }
                else
                {
                    Nav.NavigateTo("/", true);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading config: {ex.Message}");
            }
        }
    }

    private void GoPractice() => Nav.NavigateTo("/practice");

    private async Task OnUploaded()
    {
        showUpload = false;
        var res = await Http.GetFromJsonAsync<AnalyticsResponse>($"/api/analytics?grade={grade}&subject={subject}");
        report = res?.report ?? new List<ReportItem>();
        hasData = report.Count > 0;
        StateHasChanged();
    }

    private async Task LoadAdvice()
    {
        var resp = await Http.PostAsJsonAsync("/api/advice", new { grade, subject });
        if (resp.IsSuccessStatusCode)
        {
            advice = await resp.Content.ReadFromJsonAsync<AdviceResult>(new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            StateHasChanged();
        }
    }

    private class Config { public int grade { get; set; } public string? subject { get; set; } public string? textbookVersion { get; set; } }
    private class AnalyticsResponse { public List<ReportItem> report { get; set; } = new(); }
    private class ReportItem { public string knowledgePoint { get; set; } = ""; public double accuracy { get; set; } public string mastery { get; set; } = ""; }
    private class AdviceResult { public string summary { get; set; } = ""; public string tone { get; set; } = ""; public List<string> suggestions { get; set; } = new(); }
}
