@page "/kp"
@inject IJSRuntime JS
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>知识点题目</PageTitle>

<div class="container mt-3">
    @if (!initialized)
    {
        <p>正在加载...</p>
    }
    else if (string.IsNullOrEmpty(subject) || grade == 0 || string.IsNullOrEmpty(kp))
    {
        <div class="alert alert-warning">参数缺失，请返回</div>
        <a href="/dashboard" class="btn btn-link">返回学习中心</a>
    }
    else
    {
        <div class="card">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                <span class="h5 mb-0">知识点：@kp</span>
                <a href="/dashboard" class="btn btn-outline-primary btn-sm">返回学习中心</a>
            </div>
            <div class="card-body">
                @if (items.Count == 0)
                {
                    <div class="alert alert-info">暂无题目</div>
                }
                else
                {
                    <div class="d-flex flex-column gap-4">
                        @{ int index = 1; }
                        @foreach (var q in items)
                        {
                            var ok = q.IsCorrect == true;
                            var headerClass = ok ? "bg-success bg-opacity-10 text-success" : "bg-danger bg-opacity-10 text-danger";
                            var borderClass = ok ? "border-success" : "border-danger";
                            var statusText = ok ? "回答正确" : "回答错误";
                            var icon = ok ? "oi-check" : "oi-x";

                            <div class="card border-0 shadow-sm">
                                <div class="card-header @headerClass border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-white text-dark border shadow-sm">@q.QuestionType</span>
                                        <span class="fw-bold">题目 @(index++)</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-1 fw-bold">
                                        <span class="oi @icon"></span>
                                        <span>@statusText</span>
                                    </div>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-4">
                                        <h5 class="card-title text-dark mb-3" style="line-height: 1.6;">@q.Content</h5>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="p-3 rounded-3 bg-light border h-100">
                                                <div class="small text-muted text-uppercase fw-bold mb-2">用户作答</div>
                                                <div class="fw-bold @(ok ? "text-success" : "text-danger")">
                                                    @(string.IsNullOrEmpty(q.UserAnswer) ? "—" : q.UserAnswer)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="p-3 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-25 h-100">
                                                <div class="small text-success text-uppercase fw-bold mb-2">标准答案</div>
                                                <div class="fw-bold text-success">
                                                    @(string.IsNullOrEmpty(q.CorrectAnswer) ? "—" : q.CorrectAnswer)
                                                </div>
                                            </div>
                                        </div>
                                        @if (!ok && !string.IsNullOrEmpty(q.ErrorAnalysis))
                                        {
                                            <div class="col-12">
                                                <div class="p-3 rounded-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 mt-2">
                                                    <div class="d-flex align-items-center gap-2 mb-2 text-danger">
                                                        <span class="oi oi-lightbulb"></span>
                                                        <span class="small text-uppercase fw-bold">错误解析</span>
                                                    </div>
                                                    <div class="text-dark">@q.ErrorAnalysis</div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private int grade;
    private string subject = "";
    private string textbookVersion = "";
    private string kp = "";
    private bool initialized = false;
    private List<QuestionItem> items = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var cfg = await JS.InvokeAsync<Config>("loadConfig");
                grade = cfg.grade;
                subject = cfg.subject ?? "";
                textbookVersion = cfg.textbookVersion ?? "";
                var uri = Nav.ToAbsoluteUri(Nav.Uri);
                var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
                if (query.TryGetValue("kp", out var v)) kp = v.ToString();
                initialized = true;
                StateHasChanged();

                if (!string.IsNullOrEmpty(subject) && grade > 0 && !string.IsNullOrEmpty(kp))
                {
                    var state = await AuthStateProvider.GetAuthenticationStateAsync();
                    var userId = state.User.Identity?.Name ?? "demo_user";
                    var res = await Http.GetFromJsonAsync<List<QuestionItem>>($"/api/questions?grade={grade}&subject={subject}&kp={Uri.EscapeDataString(kp)}&userId={userId}");
                    items = res ?? new List<QuestionItem>();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Load kp failed: {ex.Message}");
            }
        }
    }

    private class Config { public int grade { get; set; } public string? subject { get; set; } public string? textbookVersion { get; set; } }
    private class QuestionItem
    {
        public string QuestionId { get; set; } = "";
        public string QuestionType { get; set; } = "";
        public string Content { get; set; } = "";
        public bool? IsCorrect { get; set; }
        public string? UserAnswer { get; set; }
        public string? CorrectAnswer { get; set; }
        public string ErrorAnalysis { get; set; } = "";
    }
}
